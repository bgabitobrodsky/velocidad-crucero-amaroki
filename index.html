<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Simulador Control de Velocidad Amarok</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
  />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="dropdown position-fixed top-0 start-0 m-3" style="z-index: 1200;">
    <button
      class="btn btn-primary btn-sm dropdown-toggle"
      type="button"
      data-bs-toggle="dropdown"
      aria-expanded="false"
    >
      <i class="bi bi-bezier2 me-1"></i>
      Pruebas rápidas
    </button>
    <div class="dropdown-menu p-0 shadow" style="min-width: 260px;">
      <div class="p-3 border-bottom small text-uppercase text-muted">
        Escenarios de análisis
      </div>
      <button
        class="dropdown-item small test-case-btn py-2"
        data-speed="80"
        data-initial-speed="70"
        data-pert-type="headwind"
        data-magnitude="30"
        data-pert-duration="10"
        data-sim-duration="25"
      >
        <strong>80 km/h · Viento en contra 30 km/h</strong>
        <div class="text-muted">10 s perturbación · 15 s recuperación</div>
      </button>
      <button
        class="dropdown-item small test-case-btn py-2"
        data-speed="90"
        data-initial-speed="95"
        data-pert-type="tailwind"
        data-magnitude="20"
        data-pert-duration="10"
        data-sim-duration="20"
      >
        <strong>90 km/h · Viento a favor 20 km/h</strong>
        <div class="text-muted">10 s impulso · 10 s estabilización</div>
      </button>
      <button
        class="dropdown-item small test-case-btn py-2"
        data-speed="70"
        data-initial-speed="65"
        data-pert-type="uphill"
        data-magnitude="10"
        data-pert-duration="10"
        data-sim-duration="30"
      >
        <strong>70 km/h · Pendiente subida 10°</strong>
        <div class="text-muted">10 s subida · 20 s respuesta PI</div>
      </button>
      <button
        class="dropdown-item small test-case-btn py-2"
        data-speed="110"
        data-initial-speed="100"
        data-pert-type="load"
        data-magnitude="250"
        data-pert-duration="10"
        data-sim-duration="35"
      >
        <strong>110 km/h · Carga +250 kg</strong>
        <div class="text-muted">10 s carga · 25 s recuperación</div>
      </button>
    </div>
  </div>
  <div class="container py-4">
    <h1 class="mb-4 h3">Simulador de Control de Velocidad - Amarok</h1>

    <div class="row g-3 align-items-start">
      <div class="col-lg-4 d-flex flex-column gap-3">
        <div class="card">
          <div class="card-body d-flex flex-column gap-3">
            <h2 class="h6 mb-0">Velocímetro</h2>
            <div class="speedometer-wrapper">
              <div class="speedometer speedometer-compact">
                <div class="speedometer-major-ticks">
                  <span style="--angle:-120deg"></span>
                  <span style="--angle:-100deg"></span>
                  <span style="--angle:-80deg"></span>
                  <span style="--angle:-60deg"></span>
                  <span style="--angle:-40deg"></span>
                  <span style="--angle:-20deg"></span>
                  <span style="--angle:0deg"></span>
                  <span style="--angle:20deg"></span>
                  <span style="--angle:40deg"></span>
                  <span style="--angle:60deg"></span>
                  <span style="--angle:80deg"></span>
                  <span style="--angle:100deg"></span>
                  <span style="--angle:120deg"></span>
                </div>
                <div class="speedometer-scale">
                  <span style="--angle:-120deg">0</span>
                  <span style="--angle:-100deg">20</span>
                  <span style="--angle:-80deg">40</span>
                  <span style="--angle:-60deg">60</span>
                  <span style="--angle:-40deg">80</span>
                  <span style="--angle:-20deg">100</span>
                  <span style="--angle:0deg">120</span>
                  <span style="--angle:20deg">140</span>
                  <span style="--angle:40deg">160</span>
                  <span style="--angle:60deg">180</span>
                  <span style="--angle:80deg">200</span>
                  <span style="--angle:100deg">220</span>
                  <span style="--angle:120deg">240</span>
                </div>
                <div class="speedometer-needle" id="speedometerNeedle"></div>
                <div class="speedometer-center"></div>
                <div class="speedometer-inner-gauge"></div>
                <div class="speedometer-value">
                  <span class="speedometer-value-number" id="currentSpeedLabel">0</span>
                  <span class="speedometer-value-unit">km/h</span>
                </div>
              </div>
            </div>
            <p class="text-end small text-muted mb-0">
              Tiempo simulado:
              <strong id="timeLabel">0.0</strong> s
            </p>
            <div class="speed-control d-flex align-items-center gap-2">
              <button id="decreaseSpeed" class="btn btn-outline-secondary btn-sm speed-step-btn">
                <i class="bi bi-dash-lg"></i>
              </button>
              <div class="speed-target-display flex-grow-1 text-center">
                <span class="label text-uppercase small text-muted">Velocidad seleccionada</span>
                <div class="display-value">
                  <strong id="setSpeedLabel">80</strong> km/h
                </div>
              </div>
              <button id="increaseSpeed" class="btn btn-outline-secondary btn-sm speed-step-btn">
                <i class="bi bi-plus-lg"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="card flex-fill">
          <div class="card-body d-flex flex-column gap-3">
            <h2 class="h5 mb-2">Configuración de perturbaciones</h2>

            <div class="perturbation-row d-flex flex-wrap gap-2 align-items-end">
              <div class="flex-grow-1 min-width-0">
                <label for="pertType" class="form-label form-label-compact">Tipo</label>
                <select id="pertType" class="form-select form-select-sm">
                  <option value="headwind">Viento en contra</option>
                  <option value="tailwind">Viento a favor</option>
                  <option value="uphill">Pendiente en subida</option>
                  <option value="downhill">Pendiente en bajada</option>
                  <option value="load">Aumento de carga</option>
                </select>
              </div>
              <div class="perturbation-field flex-grow-1 min-width-0">
                <label for="pertMagnitude" class="form-label form-label-compact d-flex justify-content-between">
                  <span id="pertMagnitudeLabel">Magnitud</span>
                  <small class="text-muted" id="pertMagnitudeHint">Rango 0-60</small>
                </label>
                <div class="input-group input-group-sm">
                  <input
                    type="number"
                    id="pertMagnitude"
                    class="form-control form-control-sm"
                    min="0"
                    max="60"
                    step="2"
                    value="10"
                  />
                  <span class="input-group-text" id="pertUnitSuffix">km/h</span>
                </div>
              </div>
              <div class="perturbation-field">
                <label for="pertDuration" class="form-label form-label-compact">Duración (s)</label>
                <select id="pertDuration" class="form-select form-select-sm">
                  <option value="2">2</option>
                  <option value="5" selected>5</option>
                  <option value="10">10</option>
                  <option value="20">20</option>
                </select>
              </div>
              <div>
                <button id="applyPerturbation" class="btn btn-primary btn-sm">
                  Aplicar
                </button>
              </div>
            </div>
            <div class="perturbation-feedback">
              <div class="small text-muted" id="perturbationNotes">
                Elige un tipo de perturbación para ver su equivalente en torque.
              </div>
              <div class="small fw-semibold mt-1">
                Torque equivalente: <span id="pertTorquePreview">0 Nm</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-8 d-flex flex-column gap-3">
        <div class="card">
          <div class="card-body d-flex flex-wrap align-items-center gap-3">
            <button
              id="toggleSimulation"
              class="btn btn-success btn-sm d-flex align-items-center gap-1"
              data-play-label="Iniciar"
              data-pause-label="Pausar"
            >
              <i class="bi bi-play-fill" id="toggleSimulationIcon"></i>
              <span id="toggleSimulationLabel">Iniciar</span>
            </button>
            <button
              id="resetSimulation"
              class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-2"
            >
              <i class="bi bi-arrow-counterclockwise"></i>
              Resetear
            </button>

            <div class="controller-indicators d-flex align-items-center gap-2">
              <div class="controller-light" id="kpIndicator">
                <span>KP</span>
              </div>
              <div class="controller-light" id="kiIndicator">
                <span>KI</span>
              </div>
            </div>

            <div class="controller-switches d-flex flex-wrap align-items-center">
              <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" id="kpToggle" checked />
                <label class="form-check-label" for="kpToggle">P activo</label>
              </div>
              <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" id="kiToggle" checked />
                <label class="form-check-label" for="kiToggle">I activo</label>
              </div>
            </div>

            <div class="ms-auto simulation-speed">
              <label for="simulationSpeed" class="form-label form-label-compact mb-1">
                Velocidad de simulación
              </label>
              <select id="simulationSpeed" class="form-select form-select-sm">
                <option value="0.4">0.4x (lento)</option>
                <option value="0.6" selected>0.6x</option>
                <option value="1">1x</option>
                <option value="1.5">1.5x</option>
              </select>
            </div>
          </div>
        </div>

        <div
          id="activePerturbationPanel"
          class="alert alert-warning d-none small py-2 px-3 mb-0 d-flex justify-content-between align-items-center gap-2"
        >
          <span class="text-uppercase text-muted">Perturbación activa</span>
          <span class="fw-semibold text-dark" id="activePerturbationSummary">Sin pert.</span>
        </div>

        <div class="card flex-fill">
          <div class="card-body d-flex flex-column">
            <h2 class="h5 mb-3">Velocidades y log de la simulación</h2>
            <canvas id="simulationChart" height="260"></canvas>

            <div class="mt-4">
              <h3 class="h6 mb-2">Estado del sistema</h3>
              <div class="row row-cols-2 row-cols-md-4 g-3 small text-uppercase text-muted">
                <div class="col">
                  <div>Vel. real</div>
                  <div class="fw-semibold text-dark" id="statusActualSpeed">0.0 km/h</div>
                </div>
                <div class="col">
                  <div>Error</div>
                  <div class="fw-semibold text-dark" id="statusError">0.0 km/h</div>
                </div>
                <div class="col">
                  <div>Control</div>
                  <div class="fw-semibold text-dark" id="statusControl">0 %</div>
                </div>
                <div class="col">
                  <div>Pert. torque</div>
                  <div class="fw-semibold text-dark" id="statusPerturbationTorque">0 Nm</div>
                </div>
              </div>
            </div>

            <div class="mt-4">
              <h3 class="h6 mb-2">Log detallado (del más reciente al más antiguo)</h3>
              <div id="logPanel" class="log-panel small flex-grow-1"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="script.js"></script>
</body>
</html>
