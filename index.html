<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Simulador Control de Velocidad Amarok</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
  />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="dropdown position-fixed top-0 start-0 m-3" style="z-index: 1200;">
    <button
      class="btn btn-primary btn-sm dropdown-toggle"
      type="button"
      data-bs-toggle="dropdown"
      aria-expanded="false"
    >
      <i class="bi bi-bezier2 me-1"></i>
      Pruebas rápidas
    </button>
    <div class="dropdown-menu p-0 shadow" style="min-width: 260px;">
      <div class="p-3 border-bottom small text-uppercase text-muted">
        Escenarios de análisis
      </div>
      <button
        class="dropdown-item small test-case-btn py-2"
        data-speed="80"
        data-initial-speed="70"
        data-pert-type="headwind"
        data-magnitude="30"
        data-pert-duration="10"
        data-pert-start="5"
        data-sim-duration="25"
      >
        <strong>80 km/h · Viento en contra 30 km/h</strong>
        <div class="text-muted">Inicio a los 5 s · 10 s perturbación · 15 s recuperación</div>
      </button>
      <button
        class="dropdown-item small test-case-btn py-2"
        data-speed="90"
        data-initial-speed="95"
        data-pert-type="tailwind"
        data-magnitude="25"
        data-pert-duration="8"
        data-pert-start="4"
        data-sim-duration="22"
      >
        <strong>90 km/h · Viento a favor 25 km/h</strong>
        <div class="text-muted">Impulso corto a los 4 s · 8 s perturbación · 14 s ajuste</div>
      </button>
      <button
        class="dropdown-item small test-case-btn py-2"
        data-speed="70"
        data-initial-speed="75"
        data-pert-type="uphill"
        data-magnitude="12"
        data-pert-duration="12"
        data-pert-start="6"
        data-sim-duration="32"
      >
        <strong>70 km/h · Pendiente subida 12°</strong>
        <div class="text-muted">Subida a los 6 s · 12 s perturbación · 14 s respuesta PI</div>
      </button>
      <button
        class="dropdown-item small test-case-btn py-2"
        data-speed="110"
        data-initial-speed="105"
        data-pert-type="load"
        data-magnitude="200"
        data-pert-duration="10"
        data-pert-start="8"
        data-sim-duration="35"
      >
        <strong>110 km/h · Carga +200 kg</strong>
        <div class="text-muted">Carga extra a los 8 s · 10 s · 17 s recuperación</div>
      </button>
      <button
        class="dropdown-item small test-case-btn py-2"
        data-speed="85"
        data-initial-speed="80"
        data-pert-type="headwind"
        data-magnitude="15"
        data-pert-duration="10"
        data-pert-start="5"
        data-sim-duration="30"
        data-speed-step-time="15"
        data-speed-step-value="95"
      >
        <strong>Cambio de setpoint: 85 → 95 km/h</strong>
        <div class="text-muted">Viento en contra 15 km/h a los 5 s · cambio de setpoint en el segundo 15</div>
      </button>
      <div class="border-top p-2">
        <button
          type="button"
          class="btn btn-outline-primary btn-sm w-100 d-flex align-items-center justify-content-center gap-2"
          data-bs-toggle="modal"
          data-bs-target="#customTestModal"
        >
          <i class="bi bi-sliders"></i>
          Prueba custom
        </button>
      </div>
    </div>
  </div>
  <div class="container py-4">
    <h1 class="mb-4 h3">Simulador de Control de Velocidad - Amarok</h1>

    <div class="row g-3 align-items-start">
      <div class="col-lg-4 d-flex flex-column gap-3">
        <div class="card">
          <div class="card-body d-flex flex-column gap-3">
            <h2 class="h6 mb-0">Velocímetro</h2>
            <div class="speedometer-wrapper">
              <div class="speedometer speedometer-compact">
                <div class="speedometer-major-ticks">
                  <span style="--angle:-120deg"></span>
                  <span style="--angle:-100deg"></span>
                  <span style="--angle:-80deg"></span>
                  <span style="--angle:-60deg"></span>
                  <span style="--angle:-40deg"></span>
                  <span style="--angle:-20deg"></span>
                  <span style="--angle:0deg"></span>
                  <span style="--angle:20deg"></span>
                  <span style="--angle:40deg"></span>
                  <span style="--angle:60deg"></span>
                  <span style="--angle:80deg"></span>
                  <span style="--angle:100deg"></span>
                  <span style="--angle:120deg"></span>
                </div>
                <div class="speedometer-scale">
                  <span style="--angle:-120deg">0</span>
                  <span style="--angle:-100deg">20</span>
                  <span style="--angle:-80deg">40</span>
                  <span style="--angle:-60deg">60</span>
                  <span style="--angle:-40deg">80</span>
                  <span style="--angle:-20deg">100</span>
                  <span style="--angle:0deg">120</span>
                  <span style="--angle:20deg">140</span>
                  <span style="--angle:40deg">160</span>
                  <span style="--angle:60deg">180</span>
                  <span style="--angle:80deg">200</span>
                  <span style="--angle:100deg">220</span>
                  <span style="--angle:120deg">240</span>
                </div>
                <div class="speedometer-needle" id="speedometerNeedle"></div>
                <div class="speedometer-center"></div>
                <div class="speedometer-inner-gauge"></div>
                <div class="speedometer-value">
                  <span class="speedometer-value-number" id="currentSpeedLabel">0</span>
                  <span class="speedometer-value-unit">km/h</span>
                </div>
              </div>
            </div>
            <p class="text-end small text-muted mb-0">
              Tiempo simulado:
              <strong id="timeLabel">0.0</strong> s
            </p>
            <div class="speed-control d-flex align-items-center gap-2">
              <button id="decreaseSpeed" class="btn btn-outline-secondary btn-sm speed-step-btn">
                <i class="bi bi-dash-lg"></i>
              </button>
              <div class="speed-target-display flex-grow-1 text-center">
                <span class="label text-uppercase small text-muted">Velocidad seleccionada</span>
                <div class="display-value">
                  <strong id="setSpeedLabel">80</strong> km/h
                </div>
              </div>
              <button id="increaseSpeed" class="btn btn-outline-secondary btn-sm speed-step-btn">
                <i class="bi bi-plus-lg"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="card flex-fill">
          <div class="card-body d-flex flex-column gap-3">
            <h2 class="h5 mb-2">Configuración de perturbaciones</h2>

            <div class="perturbation-row d-flex flex-wrap gap-2 align-items-end">
              <div class="flex-grow-1 min-width-0">
                <label for="pertType" class="form-label form-label-compact">Tipo</label>
                <select id="pertType" class="form-select form-select-sm">
                  <option value="headwind">Viento en contra</option>
                  <option value="tailwind">Viento a favor</option>
                  <option value="uphill">Pendiente en subida</option>
                  <option value="downhill">Pendiente en bajada</option>
                  <option value="load">Aumento de carga</option>
                </select>
              </div>
              <div class="perturbation-field flex-grow-1 min-width-0">
                <label for="pertMagnitude" class="form-label form-label-compact d-flex justify-content-between">
                  <span id="pertMagnitudeLabel">Magnitud</span>
                  <small class="text-muted" id="pertMagnitudeHint">Rango 0-60</small>
                </label>
                <div class="input-group input-group-sm">
                  <input
                    type="number"
                    id="pertMagnitude"
                    class="form-control form-control-sm"
                    min="0"
                    max="60"
                    step="2"
                    value="10"
                  />
                  <span class="input-group-text" id="pertUnitSuffix">km/h</span>
                </div>
              </div>
              <div class="perturbation-field">
                <label for="pertDuration" class="form-label form-label-compact">Duración (s)</label>
                <select id="pertDuration" class="form-select form-select-sm">
                  <option value="2">2</option>
                  <option value="5" selected>5</option>
                  <option value="10">10</option>
                  <option value="20">20</option>
                </select>
              </div>
              <div>
                <button id="applyPerturbation" class="btn btn-primary btn-sm">
                  Aplicar
                </button>
              </div>
            </div>
            <div class="perturbation-feedback">
              <div class="small text-muted" id="perturbationNotes">
                Elige un tipo de perturbación para ver su equivalente en torque.
              </div>
              <div class="small fw-semibold mt-1">
                Torque equivalente: <span id="pertTorquePreview">0 Nm</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-8 d-flex flex-column gap-3">
        <div class="card">
          <div class="card-body d-flex flex-wrap align-items-center gap-3">
            <button
              id="toggleSimulation"
              class="btn btn-success btn-sm d-flex align-items-center gap-1"
              data-play-label="Iniciar"
              data-pause-label="Pausar"
            >
              <i class="bi bi-play-fill" id="toggleSimulationIcon"></i>
              <span id="toggleSimulationLabel">Iniciar</span>
            </button>
            <button
              id="resetSimulation"
              class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-2"
            >
              <i class="bi bi-arrow-counterclockwise"></i>
              Resetear
            </button>

            <div class="controller-indicators d-flex align-items-center gap-2">
              <div class="controller-light" id="kpIndicator">
                <span>KP</span>
              </div>
              <div class="controller-light" id="kiIndicator">
                <span>KI</span>
              </div>
            </div>

            <div class="controller-switches d-flex flex-wrap align-items-center">
              <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" id="kpToggle" checked />
                <label class="form-check-label" for="kpToggle">P activo</label>
              </div>
              <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" id="kiToggle" checked />
                <label class="form-check-label" for="kiToggle">I activo</label>
              </div>
            </div>

            <div class="ms-auto simulation-speed">
              <label for="simulationSpeed" class="form-label form-label-compact mb-1">
                Velocidad de simulación
              </label>
              <select id="simulationSpeed" class="form-select form-select-sm">
                <option value="0.4">0.4x (lento)</option>
                <option value="0.6" selected>0.6x</option>
                <option value="1">1x</option>
                <option value="1.5">1.5x</option>
              </select>
            </div>
          </div>
        </div>

        <div
          id="activePerturbationPanel"
          class="alert alert-warning d-none small py-2 px-3 mb-0 d-flex justify-content-between align-items-center gap-2"
        >
          <span class="text-uppercase text-muted">Perturbación activa</span>
          <span class="fw-semibold text-dark" id="activePerturbationSummary">Sin pert.</span>
        </div>

        <div class="card flex-fill">
          <div class="card-body d-flex flex-column">
            <h2 class="h5 mb-3">Velocidades y log de la simulación</h2>
            <canvas id="simulationChart" height="260"></canvas>

            <div class="mt-4">
              <h3 class="h6 mb-2">Estado del sistema</h3>
              <div class="row row-cols-2 row-cols-md-4 g-3 small text-uppercase text-muted">
                <div class="col">
                  <div>Vel. real</div>
                  <div class="fw-semibold text-dark" id="statusActualSpeed">0.0 km/h</div>
                </div>
                <div class="col">
                  <div>Error</div>
                  <div class="fw-semibold text-dark" id="statusError">0.0 km/h</div>
                </div>
                <div class="col">
                  <div>Control</div>
                  <div class="fw-semibold text-dark" id="statusControl">0 %</div>
                </div>
                <div class="col">
                  <div>Pert. torque</div>
                  <div class="fw-semibold text-dark" id="statusPerturbationTorque">0 Nm</div>
                </div>
              </div>
            </div>

            <div class="mt-4">
              <h3 class="h6 mb-2">Log detallado (del más reciente al más antiguo)</h3>
              <div id="logPanel" class="log-panel small flex-grow-1"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div
    class="modal fade"
    id="customTestModal"
    tabindex="-1"
    aria-labelledby="customTestModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <form class="modal-content" id="customTestForm">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="customTestModalLabel">Prueba custom</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p class="small text-muted">
            Configura los mismos parámetros que usan las pruebas predefinidas y ejecuta un escenario personalizado.
          </p>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="customInitialSpeed" class="form-label">Velocidad inicial (km/h)</label>
              <input
                type="number"
                class="form-control"
                id="customInitialSpeed"
                name="customInitialSpeed"
                min="0"
                max="200"
                step="1"
                value="70"
              />
            </div>
            <div class="col-md-6">
              <label for="customTargetSpeed" class="form-label">Velocidad seleccionada (km/h)</label>
              <input
                type="number"
                class="form-control"
                id="customTargetSpeed"
                name="customTargetSpeed"
                min="0"
                max="200"
                step="1"
                value="80"
              />
            </div>
            <div class="col-md-6">
              <label for="customPertType" class="form-label">Tipo de perturbación</label>
              <select id="customPertType" name="customPertType" class="form-select">
                <option value="headwind">Viento en contra</option>
                <option value="tailwind">Viento a favor</option>
                <option value="uphill">Pendiente en subida</option>
                <option value="downhill">Pendiente en bajada</option>
                <option value="load">Aumento de carga</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="customPertMagnitude" class="form-label">Magnitud perturbación</label>
              <div class="input-group">
                <input
                  type="number"
                  class="form-control"
                  id="customPertMagnitude"
                  name="customPertMagnitude"
                  step="1"
                  min="0"
                  value="15"
                />
                <span class="input-group-text">Valor según tipo</span>
              </div>
            </div>
            <div class="col-md-6">
              <label for="customPertStart" class="form-label">Inicio perturbación (s)</label>
              <input
                type="number"
                class="form-control"
                id="customPertStart"
                name="customPertStart"
                min="0"
                step="0.5"
                value="5"
              />
            </div>
            <div class="col-md-6">
              <label for="customPertDuration" class="form-label">Duración perturbación (s)</label>
              <input
                type="number"
                class="form-control"
                id="customPertDuration"
                name="customPertDuration"
                min="0"
                step="0.5"
                value="10"
              />
            </div>
            <div class="col-md-6">
              <label for="customSimulationDuration" class="form-label">Duración simulación total (s)</label>
              <input
                type="number"
                class="form-control"
                id="customSimulationDuration"
                name="customSimulationDuration"
                min="0"
                step="1"
                value="30"
              />
            </div>
            <div class="col-md-6">
              <label class="form-label">Cambio de velocidad seleccionada (opcional)</label>
              <div class="row g-2">
                <div class="col-6">
                  <input
                    type="number"
                    class="form-control"
                    id="customSpeedStepTime"
                    name="customSpeedStepTime"
                    min="0"
                    step="0.5"
                    placeholder="Tiempo (s)"
                  />
                </div>
                <div class="col-6">
                  <input
                    type="number"
                    class="form-control"
                    id="customSpeedStepValue"
                    name="customSpeedStepValue"
                    min="0"
                    max="200"
                    step="1"
                    placeholder="Nuevo velocidad"
                  />
                </div>
              </div>
              <small class="text-muted">Deja ambos campos vacíos para omitir este evento.</small>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-play-fill me-1"></i>
            Ejecutar prueba
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="script.js"></script>
</body>
</html>
